<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arduino Piano Buzzer Song Creator</title>
  <link rel="stylesheet" href="./styles.css">
  <link rel="icon" type="image/x-icon" href="./favicon.png" />
</head>
<body>
  <h1>Arduino Piano Buzzer Song Creator V2 <br> <small>By momentollogy</small><br></h1>
  <div id="piano">
    <div class="key white extra" data-note="36" data-key="">⠀</div>
    <div class="key black extra" data-note="37" data-key="">⠀</div>
    <div class="key white extra" data-note="38" data-key="">⠀</div>
    <div class="key black extra" data-note="39" data-key="">⠀</div>
    <div class="key white extra" data-note="40" data-key="">⠀</div>
    <div class="key white extra" data-note="41" data-key="">⠀</div>
    <div class="key black extra" data-note="42" data-key="">⠀</div>
    <div class="key white extra" data-note="43" data-key="">⠀</div>
    <div class="key black extra" data-note="44" data-key="">⠀</div>
    <div class="key white extra" data-note="45" data-key="">⠀</div>
    <div class="key black extra" data-note="46" data-key="">⠀</div>
    <div class="key white extra" data-note="47" data-key="">⠀</div>
    <div class="key white extra" data-note="48" data-key="Q">Q</div>
    <div class="key black extra" data-note="49" data-key="2">2</div>
    <div class="key white extra" data-note="50" data-key="W">W</div>
    <div class="key black extra" data-note="51" data-key="3">3</div>
    <div class="key white extra" data-note="52" data-key="E">E</div>
    <div class="key white extra" data-note="53" data-key="R">R</div>
    <div class="key black extra" data-note="54" data-key="5">5</div>
    <div class="key white extra" data-note="55" data-key="T">T</div>
    <div class="key black extra" data-note="56" data-key="6">6</div>
    <div class="key white" data-note="57" data-key="Y">Y</div>
    <div class="key black" data-note="58" data-key="7">7</div>
    <div class="key white" data-note="59" data-key="U">U</div>
    <div class="key white" data-note="60" data-key="I">I</div>
    <div class="key black" data-note="61" data-key="9">9</div>
    <div class="key white" data-note="62" data-key="O">O</div>
    <div class="key black" data-note="63" data-key="0">0</div>
    <div class="key white" data-note="64" data-key="P">P</div>
    <div class="key white" data-note="65" data-key="Z">Z</div>
    <div class="key black" data-note="66" data-key="S">S</div>
    <div class="key white" data-note="67" data-key="X">X</div>
    <div class="key black" data-note="68" data-key="D">D</div>
    <div class="key white" data-note="69" data-key="C">C</div>
    <div class="key black" data-note="70" data-key="F">F</div>
    <div class="key white" data-note="71" data-key="V">V</div>
    <div class="key white" data-note="72" data-key="B">B</div>
    <div class="key black" data-note="73" data-key="H">H</div>
    <div class="key white" data-note="74" data-key="N">N</div>
    <div class="key black extra" data-note="75" data-key="J">J</div>
    <div class="key white extra" data-note="76" data-key="M">M</div>
    <div class="key white extra" data-note="77" data-key=",">,</div>
    <div class="key black extra" data-note="78" data-key="L">L</div>
    <div class="key white extra" data-note="79" data-key=".">.</div>
    <div class="key black extra" data-note="80" data-key=";">;</div>
    <div class="key white extra" data-note="81" data-key="/">/</div>
    <div class="key black extra" data-note="82" data-key="'">'</div>
    <div class="key white extra" data-note="83" data-key="">⠀</div>
    <div class="key white extra" data-note="84" data-key="">⠀</div>
    <div class="key black extra" data-note="85" data-key="">⠀</div>
    <div class="key white extra" data-note="86" data-key="">⠀</div>
    <div class="key black extra" data-note="87" data-key="">⠀</div>
    <div class="key white extra" data-note="88" data-key="">⠀</div>
    <div class="key white extra" data-note="89" data-key="">⠀</div>
    <div class="key black extra" data-note="90" data-key="">⠀</div>
    <div class="key white extra" data-note="91" data-key="">⠀</div>
    <div class="key black extra" data-note="92" data-key="">⠀</div>
    <div class="key white extra" data-note="93" data-key="">⠀</div>
    <div class="key black extra" data-note="94" data-key="">⠀</div>
    <div class="key white extra" data-note="95" data-key="">⠀</div>
    <div class="key white extra" data-note="96" data-key="">⠀</div>
  </div>
  


  

<!-- RECORD and PLAYBACK BUTTONS -->
 <input type="text" id="song-title" placeholder="Enter song title" style="display: none;"value="int Untitled_Song_1" />
  <button id="record">Record</button>
  <button id="stop" disabled>Stop</button>
  <button id="clear">Clear</button>
  <button id="play" onclick="playSongArray()">Play</button>
    
  <label for="playback-tempo">Playback Tempo:</label>
<input type="number" id="playback-tempo" name="playback-tempo" min="40" max="240" value="92" step="1">



<!-- SLIDER BUTTON -->
<div id="slider-container">
    <input type="range" min="0" max="2" step="1" value="0" id="slider" style="width: 82px;" oninput="updateSliderValue(this.value)">
  </div>

<!-- METRONOME BUTTONS + post recording buttons -->
<label for="metronome-bpm">Metronome BPM: </label>
<input type="number" id="metronome-bpm" value="120" min="40" max="240" />
<button id="start-metronome">Start</button>
<button id="stop-metronome">Stop</button>
<button id="toggle-size">Toggle Size</button>

 <div id="recording"></div>
 <button id="copySongBtn" style="display: none;" onclick="copySongToClipboard(songString)">Copy Song</button>

  <br> <br> <br> <br>

<!-- LINKS -->
  <div>
    <a href="https://www.youtube.com/watch?v=O1d9LQ68KAs" target="_blank">Watch Tutorial</a>
  </div>
  
  <br>
  
  <a href="https://drive.google.com/file/d/1yrtmyYl0rtv1ygd7zXIvFQ-BlhMG3M76/view?usp=share_link" download target="_blank">
    Download Arduino IDE Code
  </a>
  </p>
  

  
<!-- LOAD ARRAY TEXTAREA UI -->
  <div>
    <textarea id="songInput" placeholder="Paste song array" style="width: 288px; height: 145px;
     overflow: auto; text-align: center;"></textarea>
    <br>
    <button onclick="window.open('https://docs.google.com/spreadsheets/d/1C9cqSvijRkJepxErd_jL0HQ4PCrjC0h7arOYj41DDOg/edit#gid=0', '_blank');">Browse/Save To Library</button>
    <button id="loadSongButton" onclick="loadSongFromInput()">Load Song</button>
    <button id="clearArray" onclick="clearSongArray()">Clear</button>
  </div>
  <br>
  <div>
    <strong>Midi Keyboard Information</strong><br/>
    <span>Id: </span><span id="midi-id"></span><br/>
    <span>Name: </span><span id="midi-name"></span><br/>
    <span>Manufacturer: </span><span id="midi-manu"></span><br/>
    <span>Keys outside of the range A3-G5 do not work.</span><br>
    <span>Midi keyboard mod made by ItzHex.</span>
  </div>
  
  

  <script>


function updateSliderValue(value) {
  sliderValue = parseInt(value);
}




   // Create a Web Audio API context
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

// Frequencies for the piano keys (C2 to C7)
const frequencies = {
  36: 65,
  37: 69,
  38: 73,
  39: 78,
  40: 82,
  41: 87,
  42: 93,
  43: 98,
  44: 104,
  45: 110,
  46: 117,
  47: 123,
  48: 131,
  49: 139,
  50: 147,
  51: 156,
  52: 165,
  53: 175,
  54: 185,
  55: 196,
  56: 208,
  57: 220,
  58: 233,
  59: 247,
  60: 262,
  61: 277,
  62: 294,
  63: 311,
  64: 330,
  65: 349,
  66: 370,
  67: 392,
  68: 415,
  69: 440,
  70: 466,
  71: 494,
  72: 523,
  73: 554,
  74: 587,
  75: 622,
  76: 659,
  77: 698,
  78: 740,
  79: 784,
  80: 831,
  81: 880,
  82: 932,
  83: 988,
  84: 1047,
  85: 1109,
  86: 1175,
  86: 1245,
  88: 1319,
  89: 1397,
  90: 1480,
  91: 1568,
  92: 1661,
  93: 1760,
  94: 1865,
  95: 1976,
  96: 2093,
};                               

const noteNames = {
  65: "NOTE_C2",
  69: "NOTE_CS2",
  73: "NOTE_D2",
  78: "NOTE_DS2",
  82: "NOTE_E2",
  87: "NOTE_F2",
  93: "NOTE_FS2",
  98: "NOTE_G2",
  104: "NOTE_GS2",
  110: "NOTE_A2",
  117: "NOTE_AS2",
  123: "NOTE_B2",
  131: "NOTE_C3",
  139: "NOTE_CS3",
  147: "NOTE_D3",
  156: "NOTE_DS3",
  165: "NOTE_E3",
  175: "NOTE_F3",
  185: "NOTE_FS3",
  196: "NOTE_G3",
  208: "NOTE_GS3",
  220: "NOTE_A3",
  233: "NOTE_AS3",
  247: "NOTE_B3",
  262: "NOTE_C4",
  277: "NOTE_CS4",
  294: "NOTE_D4",
  311: "NOTE_DS4",
  330: "NOTE_E4",
  349: "NOTE_F4",
  370: "NOTE_FS4",
  392: "NOTE_G4",
  415: "NOTE_GS4",
  440: "NOTE_A4",
  466: "NOTE_AS4",
  494: "NOTE_B4",
  523: "NOTE_C5",
  554: "NOTE_CS5",
  587: "NOTE_D5",
  622: "NOTE_DS5",
  659: "NOTE_E5",
  698: "NOTE_F5",
  740: "NOTE_FS5",
  784: "NOTE_G5",
  831: "NOTE_GS5",
  880: "NOTE_A5",
  932: "NOTE_AS5",
  988: "NOTE_B5",
  1047: "NOTE_C6",
  1109: "NOTE_CS6",
  1175: "NOTE_D6",
  1245: "NOTE_DS6",
  1319: "NOTE_E6",
  1397: "NOTE_F6",
  1480: "NOTE_FS6",
  1568: "NOTE_G6",
  1661: "NOTE_GS6",
  1760: "NOTE_A6",
  1865: "NOTE_AS6",
  1976: "NOTE_B6",
  2093: "NOTE_C7",
};

//THIS IS TO map the note names to the key codes for load button. 
const noteToKeyCode = {
  "NOTE_C2": 36,
  "NOTE_CS2": 37,
  "NOTE_D2": 38,
  "NOTE_DS2": 39,
  "NOTE_E2": 40,
  "NOTE_F2": 41,
  "NOTE_FS2": 42,
  "NOTE_G2": 43,
  "NOTE_GS2": 44,
  "NOTE_A2": 45,
  "NOTE_AS2": 46,
  "NOTE_B2": 47,
  "NOTE_C3": 48,
  "NOTE_CS3": 49,
  "NOTE_D3": 50,
  "NOTE_DS3": 51,
  "NOTE_E3": 52,
  "NOTE_F3": 53,
  "NOTE_FS3": 54,
  "NOTE_G3": 55,
  "NOTE_GS3": 56,
  "NOTE_A3": 57,
  "NOTE_AS3": 58,
  "NOTE_B3": 59,
  "NOTE_C4": 60,
  "NOTE_CS4": 61,
  "NOTE_D4": 62,
  "NOTE_DS4": 63,
  "NOTE_E4": 64,
  "NOTE_F4": 65,
  "NOTE_FS4": 66,
  "NOTE_G4": 67,
  "NOTE_GS4": 68,
  "NOTE_A4": 69,
  "NOTE_AS4": 70,
  "NOTE_B4": 71,
  "NOTE_C5": 72,
  "NOTE_CS5": 73,
  "NOTE_D5": 74,
  "NOTE_DS5": 75,
  "NOTE_E5": 76,
  "NOTE_F5": 77,
  "NOTE_FS5": 78,
  "NOTE_G5": 79,
  "NOTE_GS5": 80,
  "NOTE_A5": 81,
  "NOTE_AS5": 82,
  "NOTE_B5": 83,
  "NOTE_C6": 84,
  "NOTE_CS6": 85,
  "NOTE_D6": 86,
  "NOTE_DS6": 86,
  "NOTE_E6": 88,
  "NOTE_F6": 89,
  "NOTE_FS6": 90,
  "NOTE_G6": 91,
  "NOTE_GS6": 92,
  "NOTE_A6": 93,
  "NOTE_AS6": 94,
  "NOTE_B6": 95,
  "NOTE_C7": 96,
};

//Makes blackkeynames work
const keyNames = {
  37: "",
  39: "",
  42: "",
  44: "",
  46: "",
  49: "2",
  51: "3",
  54: "5",
  56: "6",
  58: "7",
  61: "9",
  63: "0",
  66: "S",
  68: "D",
  70: "F",
  73: "H",
  75: "J",
  78: "L",
  80: ";",
  82: "'",
  85: "",
  86: "",
  90: "",
  92: "",
  94: "",
};

document.querySelectorAll('.key.black').forEach((key) => {
  const keyCode = key.getAttribute('data-note');
  key.innerText = keyNames[keyCode] || key.innerText;
});



let playingNotes = new Set();
let sliderValue = 0.5;

function updateSliderValue(value) {
  sliderValue = parseFloat(value);
}

// Map DURATION TO NOTE LENGTH
function mapDurationToNoteLength(duration, isRest) {
  const noteLengths = {
    108: "NOTE_THIRTY_SECOND",
    216: "NOTE_SIXTEENTH",
    324: "NOTE_EIGHTH",
    486: "NOTE_DOTTED_EIGHTH",
    648: "NOTE_QUARTER",
    972: "NOTE_DOTTED_QUARTER",
    1296: "NOTE_HALF",
    2592: "NOTE_WHOLE",
  };

  if (!isRest) {
    if (sliderValue >= 1) {
      delete noteLengths[108]; // Remove 32nd notes based on the slider value
    }
    if (sliderValue >= 2) {
      delete noteLengths[216]; // Remove 16th notes based on the slider value
    }
  }

  let closestDuration = Object.keys(noteLengths).reduce((prev, curr) => {
    return Math.abs(curr - duration) < Math.abs(prev - duration) ? curr : prev;
  });

  return noteLengths[closestDuration];
}



// Function to play a note
function playNote(frequency, keyElement, onStop) {
  const oscillator = audioContext.createOscillator();
  oscillator.type = 'sine'; // Wave type
  oscillator.frequency.value = frequency;
  oscillator.connect(audioContext.destination);
  oscillator.start();

  const startTime = audioContext.currentTime * 1000;

  // Add the pressed state for the key
  keyElement.classList.add('pressed');

  const handleMouseUp = () => {
  oscillator.stop();
  keyElement.classList.remove('pressed');
  keyElement.removeEventListener('mouseup', handleMouseUp);
  const duration = (audioContext.currentTime * 1000) - startTime;
  playingNotes.delete(Number(keyElement.dataset.note)); // remove key code from playingNotes Set
  recordingNote = false; // reset recordingNote flag
  if (onStop) onStop(duration);
};

  keyElement.addEventListener('mouseup', handleMouseUp);

  return oscillator;
}


let isPlaying = false;

// Play event listener
document.getElementById('play').addEventListener('click', async () => {
  if (isPlaying) return;

  isPlaying = true;
  document.getElementById('stop').disabled = false;
  await playRecordedNotes(recordedNotes).then(() => {
    document.getElementById('stop').disabled = true;
    isPlaying = false;
  });
});



let currentOscillator = null; // Add this line

// Play and record function
function playAndRecord(frequency, keyElement) {
  const playAndRecordCallback = (duration) => {
    recordingNote = false;
    if (recording) {
      if (!recordingStartTime) {
        recordingStartTime = new Date().getTime();
      }
      const restDuration = (new Date().getTime() - recordingStartTime) - duration;
      if (restDuration > 0) {
        recordedNotes.push({ rest: true, duration: restDuration });
      }
      recordedNotes.push({
        frequency: frequency,
        duration: duration,
        startTime: new Date().getTime()
      });
      recordingStartTime = new Date().getTime();
    }
  };

  if (recordingNote) {
    const currentKeyCode = Array.from(playingNotes)[0];
    const currentKeyElement = document.querySelector(`.key[data-note="${currentKeyCode}"]`);
    if (currentKeyElement) {
      currentKeyElement.dispatchEvent(new MouseEvent('mouseup'));
    }
  }

  playNote(frequency, keyElement, playAndRecordCallback);
  recordingNote = true;
}




// PLAYRECORDED NOTES FUNCTION
async function playRecordedNotes(notes) {
  stopPlaybackRequested = false;
  const timeBetweenNotesMs = 0;
  const playbackTempo = parseInt(document.getElementById("playback-tempo").value);
  const tempoFactor = 92.6 / playbackTempo; // Calculate the tempo factor based on the default BPM (92.6) and the playback tempo

  // Disable the "Play" button while the song is playing
  const playButton = document.getElementById('play');
  playButton.disabled = true;

  for (const note of notes) {
    if (stopPlaybackRequested) {
      break;
    }

    if (note.rest) {
      const restDurationMs = noteLengthsMs[mapDurationToNoteLength(note.duration, true)];
      await new Promise(resolve => setTimeout(resolve, restDurationMs * tempoFactor + timeBetweenNotesMs));
    } else {
      const keyElement = document.querySelector(`.key[data-note="${getKeyCodeForFrequency(note.frequency)}"]`);

      if (!keyElement) {
        console.error('Could not find key element for note:', note);
        continue;
      }

      const oscillator = playNote(note.frequency, keyElement, () => {
        if (stopPlaybackRequested) {
          oscillator.stop();
        }
      });
      playbackOscillators.push(oscillator);

      const noteDurationMs = noteLengthsMs[mapDurationToNoteLength(note.duration, false)];
      await new Promise(resolve => {
        const timeout = setTimeout(() => {
          if (!stopPlaybackRequested) {
            oscillator.stop();
            keyElement.classList.remove("pressed");
          }
          resolve();
        }, noteDurationMs * tempoFactor - 50);
        playbackTimeouts.push(timeout);
      });

      await new Promise(resolve => setTimeout(resolve, timeBetweenNotesMs));
    }
  }

  // Re-enable the "Play" button when the song stops playing
  playButton.disabled = false;
}






function releaseAllKeys() {
  const pianoKeys = document.querySelectorAll('.key.pressed');
  pianoKeys.forEach(key => {
    key.classList.remove('pressed');
  });
}

function stopPlayback() {
  stopPlaybackRequested = true;

  // Clear all timeouts
  for (const timeout of playbackTimeouts) {
    clearTimeout(timeout);
  }

  // Stop all oscillators
  for (const oscillator of playbackOscillators) {
    oscillator.stop();
  }

  // Reset arrays
  playbackTimeouts = [];
  playbackOscillators = [];

  isPlaying = false; // Add this line

  // Release all pressed keys
  releaseAllKeys();
}


//event listner for mouse click on keys
const pianoKeys = document.querySelectorAll('.key');

pianoKeys.forEach(key => {
  key.addEventListener('mousedown', () => {
    const keyCode = key.dataset.note;
    if (!playingNotes.has(keyCode)) {
      playingNotes.add(keyCode);
      playAndRecord(frequencies[keyCode], key);
    }
  });

  key.addEventListener('mousemove', (event) => {
    if (event.buttons === 1) { // Check if the left mouse button is pressed
      const keyCode = key.dataset.note;
      if (!playingNotes.has(keyCode)) {
        playingNotes.add(keyCode);
        playAndRecord(frequencies[keyCode], key);
      }
    }
  });

  key.addEventListener('mouseleave', () => {
    const keyCode = key.dataset.note;
    if (playingNotes.has(keyCode)) {
      playingNotes.delete(keyCode);
      key.dispatchEvent(new MouseEvent('mouseup'));
    }
  });
});



//Funtion to add a rest
function addRestIfNeeded() {
  if (recordedNotes.length > 1) {
    const previousNote = recordedNotes[recordedNotes.length - 2];
    const restDuration = (recordedNotes[recordedNotes.length - 1].startTime) - (previousNote.startTime + previousNote.duration);
    if (restDuration > 0) {
      recordedNotes.splice(recordedNotes.length - 1, 0, { rest: true, duration: restDuration });
    }
  }
}


let recording = false;
let playing = false;
let startTime = null;
let recordedNotes = [];
let recordingNote = false;
let recordingStartTime;

// Start recording
document.getElementById('record').addEventListener('click', () => {
  recording = true;
  startTime = Date.now();
  recordedNotes = [];
  recordingStartTime = null;
  document.getElementById('record').disabled = true;
  document.getElementById('stop').disabled = false;
});

function stopPlayback() {
  stopPlaybackRequested = true;

  // Clear all timeouts
  for (const timeout of playbackTimeouts) {
    clearTimeout(timeout);
  }

  // Stop all oscillators
  for (const oscillator of playbackOscillators) {
    oscillator.stop();
  }

  // Reset arrays
  playbackTimeouts = [];
  playbackOscillators = [];

  isPlaying = false; // Add this line
}


// Stop recording
document.getElementById('stop').addEventListener('click', () => {
  recording = false;
  startTime = null;
  document.getElementById('record').disabled = false;
  document.getElementById('stop').disabled = true;
  displayRecording();
  stopMetronome();

  // Call stopPlayback() if either recording or playing
  if (recording || isPlaying) {
    stopPlayback();
    document.getElementById('play').disabled = false;
  }
});




// Clear button
document.getElementById('clear').addEventListener('click', () => {
  recordedNotes = [];
  document.getElementById("recording").innerHTML = "";
});


// Rest function
function addRest() {
  if (recording) {
    const currentTime = new Date().getTime();
    const restDuration = currentTime - recordingStartTime;
    if (restDuration >= 100) {
      recordedNotes.push({ rest: true, duration: restDuration });
    }
    recordingStartTime = currentTime;
  }
}

document.addEventListener('keydown', event => {
  const key = event.key;
  const keyElement = document.querySelector(`.key[data-key="${key.toUpperCase()}"]`);
  const keyCode = keyElement.getAttribute('data-note');
  if (keyElement && !playingNotes.has(keyCode)) {
    playingNotes.add(keyCode);
    playAndRecord(frequencies[keyCode], keyElement);
  } else if (keyElement) {
    let newNote = 0
    playingNotes
  }
});

document.addEventListener('keyup', event => {
  const key = event.key;
  const keyElement = document.querySelector(`.key[data-key="${key.toUpperCase()}"]`);
  const keyCode = keyElement.getAttribute('data-note');
  if (keyElement) {
    playingNotes.delete(keyCode);
    keyElement.dispatchEvent(new MouseEvent('mouseup'));
  }
});


// Display recording function
function displayRecording() {
  let output = "";
  const songTitle = document.getElementById("song-title").value;
  const notesCount = recordedNotes.length;

  output += `${songTitle}[${notesCount}][2] =\n{\n`;

  recordedNotes.forEach((note, index) => {
    if (note.rest) {
      output += `  {0, ${mapDurationToNoteLength(note.duration, true)}},\n`;
    } else {
      output += `  {${noteNames[note.frequency]}, ${mapDurationToNoteLength(note.duration)}},\n`;
    }
  });

  output += "};";

  const recordingElement = document.getElementById("recording");
  recordingElement.innerHTML = `<button id="copy-song">Copy Song</button><pre>${output}</pre>`;
  
  const copySongButton = document.getElementById("copy-song");
  copySongButton.addEventListener("click", () => copySongToClipboard(output));
}


function getKeyCodeForFrequency(frequency) {
  for (const [keyCode, freq] of Object.entries(frequencies)) {
    if (freq === frequency) {
      return keyCode;
    }
  }
  return null;
}

let playbackTimeouts = [];
let playbackOscillators = [];


const noteLengthsMs = {
  "NOTE_THIRTY_SECOND": 108,
  "NOTE_SIXTEENTH": 216,
  "NOTE_EIGHTH": 324,
  "NOTE_DOTTED_EIGHTH": 486,
  "NOTE_QUARTER": 648,
  "NOTE_DOTTED_QUARTER": 972,
  "NOTE_HALF": 1296,
  "NOTE_WHOLE": 2592,
};






// LOAD SONG EVENT LISTENER
document.getElementById('loadSongButton').addEventListener('click', loadSongFromInput);


// LOAD SONG FUNCTION
function loadSongFromInput() {
  const songString = document.getElementById('songInput').value;
  console.log('Song string:', songString);

  const regex = /{([^}]+)}/g;
  const rawSongData = songString.match(regex);

  if (!rawSongData) {
    alert('Invalid song format. Please make sure the input is correct.');
    return;
  }

  const songArray = rawSongData.map((item) => {
    const cleanedItem = item.replace(/[{}]/g, '');
    const values = cleanedItem.split(',').map((val) => val.trim());
    return [values[0], values[1]];
  });

  console.log('Song array:', songArray);

  const loadedSong = songArray.map(([note, duration]) => {
    const keyCode = noteToKeyCode[note];
    const noteDuration = noteLengthsMs[duration];
    return {
      frequency: note === '0' ? 0 : frequencies[keyCode],
      duration: noteDuration,
      durationString: duration,
      rest: note === '0',
    };
  });

  console.log('Loaded song:', loadedSong);
  displayLoadedSong(loadedSong);
  recordedNotes = loadedSong; // Update the recordedNotes with the loaded song data
}

//CLEAR ARRAY
function clearSongArray() {
  document.getElementById('songInput').value = '';
}



//DISPLAY LOADED SONG FUNCTION
function displayLoadedSong(songArray) {
  let output = "";
  const songTitle = document.getElementById("song-title").value;
  const notesCount = songArray.length;

  output += `${songTitle}[${notesCount}][2] =\n{\n`;

  songArray.forEach((noteObject) => {
    const note = noteObject.rest ? '0' : noteNames[noteObject.frequency];
    const duration = noteObject.durationString; // Use the original duration string
    output += `  {${note}, ${duration}},\n`;
  });

  output += "};";

  const recordingElement = document.getElementById("recording");
  recordingElement.innerHTML = `<button id="copy-song">Copy Song</button><pre>${output}</pre>`;

  const copySongButton = document.getElementById("copy-song");
  copySongButton.addEventListener("click", () => copySongToClipboard(output));
}



//QUANTIZE  STUFF
function closestDuration(duration, supportedDurations) {
  return supportedDurations.reduce((prev, curr) =>
    Math.abs(curr - duration) < Math.abs(prev - duration) ? curr : prev
  );
}

function quantizeNoteDuration(duration) {
  const supportedDurations = [108, 216, 324, 486, 648, 972, 1296, 2592];
  return closestDuration(duration, supportedDurations);
}

function quantizeRestDuration(duration) {
  const supportedDurations = [108, 216, 324, 486, 648, 972, 1296, 2592];
  return closestDuration(duration, supportedDurations);
}

// Example usage
let noteDuration = 0.37; // Example note duration value
let quantizedNoteDuration = quantizeNoteDuration(noteDuration);
console.log(quantizedNoteDuration); // output: 324 (closest to an eighth note)

let restDuration = 0.185; // Example rest duration value
let quantizedRestDuration = quantizeRestDuration(restDuration);
console.log(quantizedRestDuration); // output: 216 (closest to a sixteenth note)




//METRONOME STUFF

let metronomeInterval = null;

function createWhiteNoise() {
  const bufferSize = 4096;
  const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
  const output = buffer.getChannelData(0);

  for (let i = 0; i < bufferSize; i++) {
    output[i] = Math.random() * 2 - 1;
  }

  const whiteNoiseSource = audioContext.createBufferSource();
  whiteNoiseSource.buffer = buffer;
  whiteNoiseSource.loop = true;

  return whiteNoiseSource;
}

function startMetronome(bpm) {
  const interval = 60 / bpm * 1000;

  // Disable the "Start Metronome" button when the metronome starts
  const startMetronomeButton = document.getElementById('start-metronome');
  startMetronomeButton.disabled = true;

  metronomeInterval = setInterval(() => {
    const whiteNoiseSource = createWhiteNoise();
    const gainNode = audioContext.createGain();
    gainNode.gain.value = 0.2;

    const filterNode = audioContext.createBiquadFilter();
    filterNode.type = 'bandpass';
    filterNode.frequency.value = 2000;
    filterNode.Q.value = 0.5;

    whiteNoiseSource.connect(gainNode);
    gainNode.connect(filterNode);
    filterNode.connect(audioContext.destination);

    whiteNoiseSource.start();
    setTimeout(() => {
      whiteNoiseSource.stop();
    }, 50);
  }, interval);
}

function stopMetronome() {
  if (metronomeInterval) {
    clearInterval(metronomeInterval);
    metronomeInterval = null;
  }

  // Re-enable the "Start Metronome" button when the metronome stops
  const startMetronomeButton = document.getElementById('start-metronome');
  startMetronomeButton.disabled = false;
}

//METRONOME EVENT LISTENER
document.getElementById("start-metronome").addEventListener("click", () => {
  const bpm = parseInt(document.getElementById("metronome-bpm").value, 10);
  startMetronome(bpm);
});

document.getElementById("stop-metronome").addEventListener("click", () => {
  stopMetronome();
});




//COPYSONG TO CLIPBOARTD FUNCTION
function copySongToClipboard(songString) {
  const songElement = document.createElement('textarea');
  songElement.value = songString;
  document.body.appendChild(songElement);
  songElement.select();
  document.execCommand('copy');
  document.body.removeChild(songElement);
  alert('Song copied to clipboard');
}


// CODE FOR MIDI KEYBOARD - ItzHex

navigator.requestMIDIAccess()
    .then(onMIDISuccess, onMIDIFailure);

function onMIDISuccess(midiAccess) {
    for (var input of midiAccess.inputs.values()) {
        input.onmidimessage = getMIDIMessage;
        document.querySelector("#midi-id").innerHTML = input.id
        document.querySelector("#midi-name").innerHTML = input.name
        document.querySelector("#midi-manu").innerHTML = input.manufacturer
    }
}

function getMIDIMessage(message) {
    var command = message.data[0];
    var note = message.data[1];

    switch (command) {
        case 144: // noteOn
            noteOn(note);
            break;
        case 128: // noteOff
            noteOff(note);
            break;
    }
}

function noteOn(note) {
  const key = document.querySelector(`[data-note="${note}"]`);
  if (!playingNotes.has(note)) {
    playingNotes.add(note);
    playAndRecord(frequencies[note], key);
  }
}

function noteOff(note) {
  const key = document.querySelector(`[data-note="${note}"]`);
  if (playingNotes.has(note)) {
    playingNotes.delete(note);
    key.dispatchEvent(new MouseEvent('mouseup'));
  }
}

function onMIDIFailure() {
    console.warn('Could not access your MIDI devices. Ignore this warning if you are not trying to use any MIDI devices. Otherwise, try using the latest version of Google Chrome.');
}

// Keyboard size toggle button
document.querySelector("#toggle-size").addEventListener("click", () => {
  extraKeys = document.querySelectorAll(".extra")
  extraKeys.forEach(key => {
    key.classList.toggle("hidden-key");
  });
});

  </script>

<!-- Default Statcounter code for Arduino Buzzer Song
Creator
https://momentollogy.github.io/ArduinoPianoBuzzerSongCreator/
-->
<script type="text/javascript">
  var sc_project=12871653; 
  var sc_invisible=1; 
  var sc_security="8887c24b"; 
  </script>
  <script type="text/javascript"
  src="https://www.statcounter.com/counter/counter.js"
  async></script>
  <noscript><div class="statcounter"><a title="Web Analytics
  Made Easy - Statcounter" href="https://statcounter.com/"
  target="_blank"><img class="statcounter"
  src="https://c.statcounter.com/12871653/0/8887c24b/1/"
  alt="Web Analytics Made Easy - Statcounter"
  referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
  <!-- End of Statcounter Code -->

</body>
</html>